
flowchart TD
    %% UI Layer
    UI[React UI (ChatPage.jsx)]
    UI -.->|Sends user prompt via fetch (SSE)| API

    %% Middleware Layer
    API[FastAPI Middleware (main.py)]
    AGUI[AG-UI Event Protocol]
    API -->|Encodes/decodes events| AGUI
    API -->|Streams AG-UI events (SSE)| UI
    API -->|Fetches tool list, calls tools| MCP
    API -->|Calls Azure OpenAI| OpenAI
    API -->|Reads/writes chat history| Redis
    API -->|Logs chat & summary| MongoChat

    %% MCP Server Layer
    MCP[FastMCP Server (app.py)]
    MCP -.->|Exposes tools (search, stats, raw query, etc.)| API
    MCP -->|Queries METAR data| MongoDB

    %% Database Layer
    MongoDB[(MongoDB - METAR Data)]
    MongoChat[(MongoDB - Chat/Summary)]
    MCP --> MongoDB
    API --> MongoChat

    %% LLM Layer
    OpenAI[Azure OpenAI]

    %% Redis Layer
    Redis[(Azure Redis)]

    %% Connections
    UI -.->|Receives streamed events| API
    API -.->|Stores/loads session & chat| Redis
    API -.->|Summarizes long chats| OpenAI
    API -.->|Logs chat & summary| MongoChat

    %% AG-UI Protocol
    AGUI -.->|Defines event structure| UI

    %% Legends
    classDef db fill:#f9f,stroke:#333,stroke-width:1px;
    class MongoDB,MongoChat,Redis db;
